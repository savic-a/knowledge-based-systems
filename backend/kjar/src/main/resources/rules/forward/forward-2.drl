import com.ftn.sbnz.model.BudgetExceeding;
import com.ftn.sbnz.model.Budget;
import com.ftn.sbnz.model.Transaction;
import com.ftn.sbnz.model.TransactionEvent;
import com.ftn.sbnz.model.Warning;

import com.ftn.sbnz.enumeration.Category;
import com.ftn.sbnz.enumeration.PurchaseType;


// 1. LEVEL
// TODO: add check time (set time in backward)
rule "Week with the biggest cost" 
when
    $budgetExceeding: BudgetExceeding($clientId: clientId, criterion == 0)
    $budget: Budget($clientId == clientId)
    $monetaryAmount: Number(doubleValue > $budgetExceeding.getValue() * 0.2) from accumulate(
        $transaction : TransactionEvent(clientId == $clientId, type == TransactionEvent.Type.OUTCOME),
        sum($transaction.getValue())
    )
    eval($monetaryAmount.doubleValue() > $budgetExceeding.getValue())
then
    System.out.println("Trosak je veci od 20%");
    System.out.println($monetaryAmount);
    modify($budgetExceeding) {
        setValue($monetaryAmount.doubleValue()),
        setCriterion(1)
    }
end

// 2. LEVEL
rule "Category with the biggest cost"
when
    $budgetExceeding: BudgetExceeding($clientId: clientId, criterion == 1)
    $category: Category() from Category.values()
    $sum : Double() from accumulate (
        $t : TransactionEvent(type == TransactionEvent.Type.OUTCOME, category == $category, $clientId == clientId),
        sum($t.getValue())
    )
    $count: Long() from accumulate(
        $t: TransactionEvent(type == TransactionEvent.Type.OUTCOME, category == $category, $clientId == clientId),
        count($t)
    )
    eval($sum > $budgetExceeding.getCategoryCost())
then
    if ($budgetExceeding.getCategoryCost() < $sum)
    {
        modify($budgetExceeding) {
            setCategoryCost($sum.doubleValue()),
            setCount($count.intValue()),
            setCategory($category)
        }
        $budgetExceeding.setCategoryCost($sum.doubleValue());
        $budgetExceeding.setCount($count.intValue());
        $budgetExceeding.setCategory($category);
        update($budgetExceeding);
    }
    System.out.println("...LEVEL 2...");
    System.out.println($budgetExceeding.getCategory());
    System.out.println($budgetExceeding.getCategoryCost());
    System.out.println($budgetExceeding.getCount());
    modify($budgetExceeding) {
        setCriterion(2)
    }
end

// 3. LEVEL
rule "Frequent shopping"
when
    $budgetExceeding: BudgetExceeding($clientId: clientId, criterion == 2, count >= 5)
then
    System.out.println("Frequent shopping");
    System.out.println($budgetExceeding.getCategoryCost());
    modify($budgetExceeding) {
        setCriterion(3),
        setPurchaseType(PurchaseType.FREQUENT)
    }
end

rule "Impulsive shopping"
when
    $budgetExceeding: BudgetExceeding($clientId: clientId, criterion == 2, count < 5)
then
    System.out.println("Impulsive shopping");
    System.out.println($budgetExceeding.getCategoryCost());
    modify($budgetExceeding) {
        setCriterion(3),
        setPurchaseType(PurchaseType.IMPULSIVE)
    }
end

// 4. LEVEL
rule "Generate report"
when
    $budgetExceeding: BudgetExceeding($clientId: clientId, criterion == 3)
then
    System.out.println("Inserting new report");
    insert(new Warning($clientId, "High", "You have spent more than 20% of your monthly income on " + $budgetExceeding.getCategory() 
                        + ". Type of shopping: " + $budgetExceeding.getPurchaseType()));
    System.out.println("You have spent more than 20% of your monthly income on " + $budgetExceeding.getCategory() 
                        + ". Type of shopping: " + $budgetExceeding.getPurchaseType());
end