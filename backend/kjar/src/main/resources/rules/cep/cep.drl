import com.ftn.sbnz.event.TransactionEvent;
import com.ftn.sbnz.event.AnalysisTransaction;
import com.ftn.sbnz.model.Budget;

rule "Weekly transactions exceed 20% of budget"
    when
        $budget: Budget($bId: id, $weeklyBudget: value, $cId: clientId)
        $t1: TransactionEvent($cId == clientId)
        $totalAmount: Number(doubleValue >= $weeklyBudget * 0.2) from accumulate(
            $t2: TransactionEvent(
                clientId == $cId,
                type == TransactionEvent.Type.OUTCOME,
                this after[0d, 7d] $t1
            ),
            sum($t2.getValue())
        )
        not (AnalysisTransaction(clientId == $cId, reason == "Sudden jump in costs", type == AnalysisTransaction.FinancialGoalType.UNFAVORABLE))

    then
        System.out.println("Detected sudden jump in costs for customer " + $cId);
        System.out.println($totalAmount);
        insert(new AnalysisTransaction($cId, "Sudden jump in costs", AnalysisTransaction.FinancialGoalType.UNFAVORABLE));
end